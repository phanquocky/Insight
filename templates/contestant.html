{% extends 'base.html' %}
{% block content %}

<script>

function viewSubmit(roomID) {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/view_submit/' + roomID, true);
  xhr.responseType = 'arraybuffer';

  xhr.onload = function () {
    if (xhr.status == 200) {
      // Nếu nhận được dữ liệu thành công, tạo một blob từ arrayBuffer và mở cửa sổ mới chứa PDF
      var arrayBuffer = xhr.response;
      var blob = new Blob([arrayBuffer], { type: 'application/pdf' });
      var url = URL.createObjectURL(blob);

      // Mở cửa sổ mới chứa PDF
      window.open(url, '_blank');
    } else {
      alert('Error! Please try again!');
    }
  };

  // Gửi yêu cầu lấy dữ liệu PDF từ server
  xhr.send();
}

function submitTest(roomId) {
  var fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.pdf';  // Chỉ chấp nhận file PDF

  fileInput.onchange = function () {
    var file = fileInput.files[0];
    var formData = new FormData();
    formData.append('file', file);
    formData.append('room_id', roomId);

    // Gửi yêu cầu POST để tải lên file đề thi lên server
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/contestant', true);
    xhr.onload = function () {
        if (xhr.status == 200) {
            alert('Successful!');
            location.reload();
        } else {
            alert('Error! Please try again!');
        }
    };
    xhr.send(formData);
  };

  // Kích hoạt sự kiện click trên input[type=file] để chọn file
  fileInput.click();
}

function viewTest(roomID) {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/view_test/' + roomID, true);
  xhr.responseType = 'arraybuffer';

  xhr.onload = function () {
    if (xhr.status == 200) {
      // Nếu nhận được dữ liệu thành công, tạo một blob từ arrayBuffer và mở cửa sổ mới chứa PDF
      var arrayBuffer = xhr.response;
      var blob = new Blob([arrayBuffer], { type: 'application/pdf' });
      var url = URL.createObjectURL(blob);

      // Mở cửa sổ mới chứa PDF
      window.open(url, '_blank');
    } else {
      alert('Error! Please try again!');
    }
  };

  // Gửi yêu cầu lấy dữ liệu PDF từ server
  xhr.send();
}
</script>

  <h1 class="text-center mt-3">Contestant Room</h1>

  {% if contestant_rooms %}
    <table class="table table-bordered mt-3 text-center">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">RoomID</th>
          <th scope="col">Test</th>
          <th scope="col">Submission</th>
          <th scope="col">Level</th>
          <th scope="col">Status</th>
          <th scope="col">Mentor</th>
        </tr>
      </thead>

      <tbody class="overflow-auto">
        {% for contestant in contestant_rooms %}
        <tr>
          <th scope="row" class="col-1">{{ loop.index }}</th>
          <td class="col-3">{{ contestant._id }}</td>
          {% if not contestant.test %}
            <td class="col-1">None</td>
            <td class="col-1">No submission</td>
          {% else %}
            <td class="col-1">
              <button class="btn btn-success" onclick="viewTest('{{ contestant._id }}')">View Test</button>
            </td>
            {% if not contestant.submission %}
              <td class="col-1">
                <button class="btn btn-danger" onclick="submitTest('{{ contestant._id }}')">Submit</button>
              </td>
            {% else %}
              <td class="col-1">
                <button class="btn btn-success" onclick="viewSubmit('{{ contestant._id }}')">View submit</button>
              </td>
            {% endif %}
          {% endif %}
          <td class="col-1">{{ contestant.level }}</td>
          <td class="col-1">{{ contestant.status }}</td>
          <td class="col-2">{{ contestant.mentor }}</td>
        </tr>
          {% endfor %}
      </tbody>
    </table>

  {% else %}
    <h2 class="text-center mt-3">No room found</h2>
  {% endif %}

{% endblock %}